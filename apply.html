<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Your Video Application - Introvy.ai</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        .step-indicator {
            background: #e5e7eb;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-weight: bold;
        }
        .step-indicator.active {
            background: #667eea;
            color: white;
        }
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        .question-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        .question-card.recording {
            border-color: #ef4444;
            background: #fef2f2;
        }
        .question-card.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .difficulty-easy { background: #dcfce7; color: #166534; }
        .difficulty-medium { background: #fef3c7; color: #92400e; }
        .difficulty-hard { background: #fee2e2; color: #991b1b; }
        .plan-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .plan-free { background: #f3f4f6; color: #374151; }
        .plan-pro { background: #fbbf24; color: #92400e; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-video text-2xl text-blue-600 mr-2"></i>
                    <span class="text-xl font-bold text-gray-800">Introvy.ai</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="plan-badge plan-free" id="userPlan">Free Plan</span>
                    <a href="/" class="text-gray-600 hover:text-blue-600">
                        <i class="fas fa-home mr-1"></i>Home
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Progress Steps -->
            <div class="flex items-center justify-center mb-8">
                <div class="flex items-center space-x-4">
                    <div class="text-center">
                        <div class="step-indicator completed" id="step1">1</div>
                        <div class="text-sm mt-2">Job Details</div>
                    </div>
                    <div class="w-16 h-0.5 bg-gray-300"></div>
                    <div class="text-center">
                        <div class="step-indicator active" id="step2">2</div>
                        <div class="text-sm mt-2">AI Questions</div>
                    </div>
                    <div class="w-16 h-0.5 bg-gray-300"></div>
                    <div class="text-center">
                        <div class="step-indicator" id="step3">3</div>
                        <div class="text-sm mt-2">Record Videos</div>
                    </div>
                    <div class="w-16 h-0.5 bg-gray-300"></div>
                    <div class="text-center">
                        <div class="step-indicator" id="step4">4</div>
                        <div class="text-sm mt-2">Submit</div>
                    </div>
                </div>
            </div>

            <!-- Job Input Section -->
            <div id="jobInputSection" class="bg-white rounded-lg shadow-lg p-8 mb-8">
                <h2 class="text-2xl font-bold mb-6">Enter Job Details</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Name *</label>
                        <input type="text" id="candidateName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Your full name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job Title *</label>
                        <input type="text" id="jobTitle" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Software Engineer">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Name *</label>
                        <input type="text" id="companyName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Google">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Difficulty</label>
                        <select id="difficultyLevel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="easy">Easy - Basic questions</option>
                            <option value="medium" selected>Medium - Standard interview</option>
                            <option value="hard">Hard - Advanced (Pro only)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Job Description *</label>
                    <textarea id="jobDescription" required rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Paste the complete job description here..."></textarea>
                </div>

                <button id="generateQuestionsBtn" class="gradient-bg text-white px-8 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <i class="fas fa-magic mr-2"></i>Generate AI Questions
                </button>
            </div>

            <!-- AI Questions Section -->
            <div id="questionsSection" class="bg-white rounded-lg shadow-lg p-8 mb-8" style="display: none;">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Your Interview Questions</h2>
                    <div class="flex items-center space-x-4">
                        <div id="regenerationStatus" class="text-sm text-gray-600"></div>
                        <button id="regenerateBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-600 transition" style="display: none;">
                            <i class="fas fa-sync mr-1"></i>Regenerate
                        </button>
                    </div>
                </div>
                
                <div id="questionsContainer"></div>
                
                <div class="mt-8 text-center">
                    <button id="startRecordingBtn" class="gradient-bg text-white px-8 py-3 rounded-lg font-semibold hover:opacity-90 transition" style="display: none;">
                        <i class="fas fa-video mr-2"></i>Start Recording Videos
                    </button>
                </div>
            </div>

            <!-- Video Recording Section -->
            <div id="recordingSection" class="bg-white rounded-lg shadow-lg p-8 mb-8" style="display: none;">
                <h2 class="text-2xl font-bold mb-6">Record Your Responses</h2>
                
                <div id="currentQuestion" class="question-card mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Question <span id="questionNumber">1</span> of <span id="totalQuestions">3</span></h3>
                        <div class="difficulty-badge difficulty-medium" id="questionDifficulty">Medium</div>
                    </div>
                    <p id="questionText" class="text-gray-700 mb-4"></p>
                    
                    <div class="video-container mb-4">
                        <video id="videoPreview" autoplay muted playsinline class="w-full h-full object-cover"></video>
                        <div id="videoPlaceholder" class="absolute inset-0 flex items-center justify-center text-white">
                            <div class="text-center">
                                <i class="fas fa-video text-4xl mb-4"></i>
                                <p>Click "Start Recording" to begin</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-4">
                            <button id="startRecBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition">
                                <i class="fas fa-record-vinyl mr-2"></i>Start Recording
                            </button>
                            <button id="stopRecBtn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition" disabled>
                                <i class="fas fa-stop mr-2"></i>Stop Recording
                            </button>
                            <button id="retakeBtn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition" style="display: none;">
                                <i class="fas fa-redo mr-2"></i>Retake
                            </button>
                        </div>
                        <div id="recordingTimer" class="text-lg font-mono"></div>
                    </div>
                    
                    <div id="recordingStatus" class="mt-4 text-sm"></div>
                </div>
                
                <div class="flex justify-between">
                    <button id="prevQuestionBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition" style="display: none;">
                        <i class="fas fa-arrow-left mr-2"></i>Previous
                    </button>
                    <button id="nextQuestionBtn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition" style="display: none;">
                        Next Question<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button id="finishRecordingBtn" class="gradient-bg text-white px-8 py-3 rounded-lg font-semibold hover:opacity-90 transition" style="display: none;">
                        <i class="fas fa-check mr-2"></i>Finish Recording
                    </button>
                </div>
            </div>

            <!-- Submission Section -->
            <div id="submissionSection" class="bg-white rounded-lg shadow-lg p-8" style="display: none;">
                <div class="text-center">
                    <div class="mb-6">
                        <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Application Complete!</h2>
                        <p class="text-gray-600 mb-8">Your video application has been created successfully.</p>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg mb-8">
                        <h3 class="text-lg font-semibold mb-4">Your Submission Link</h3>
                        <div class="flex items-center bg-white p-3 rounded border">
                            <input type="text" id="submissionLink" readonly class="flex-1 bg-transparent outline-none text-sm">
                            <button id="copyLinkBtn" class="bg-blue-500 text-white px-4 py-2 rounded ml-2 hover:bg-blue-600 transition">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Share this link with employers or paste it into job applications</p>
                    </div>
                    
                    <div class="flex justify-center space-x-4">
                        <a id="viewSubmissionBtn" target="_blank" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition">
                            <i class="fas fa-eye mr-2"></i>View Submission
                        </a>
                        <button id="newSubmissionBtn" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-plus mr-2"></i>New Application
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p id="loadingText" class="text-lg font-medium">Generating questions...</p>
        </div>
    </div>

    <script>
        // Application state
        let currentUser = {
            plan: 'free', // or 'pro'
            regenerationsUsed: 0,
            maxRegenerations: 1
        };
        
        let applicationState = {
            questions: [],
            currentQuestionIndex: 0,
            videoResponses: [],
            difficulty: 'medium',
            submissionId: null
        };
        
        let mediaRecorder;
        let recordedChunks = [];
        let currentStream;
        let recordingTimer;
        let recordingStartTime;

        // DOM elements
        const generateQuestionsBtn = document.getElementById('generateQuestionsBtn');
        const regenerateBtn = document.getElementById('regenerateBtn');
        const startRecordingBtn = document.getElementById('startRecordingBtn');
        const questionsSection = document.getElementById('questionsSection');
        const recordingSection = document.getElementById('recordingSection');
        const submissionSection = document.getElementById('submissionSection');
        const loadingModal = document.getElementById('loadingModal');

        // Event listeners
        generateQuestionsBtn.addEventListener('click', generateQuestions);
        regenerateBtn.addEventListener('click', regenerateQuestions);
        startRecordingBtn.addEventListener('click', startVideoRecording);
        document.getElementById('startRecBtn').addEventListener('click', startRecording);
        document.getElementById('stopRecBtn').addEventListener('click', stopRecording);
        document.getElementById('retakeBtn').addEventListener('click', retakeVideo);
        document.getElementById('nextQuestionBtn').addEventListener('click', nextQuestion);
        document.getElementById('prevQuestionBtn').addEventListener('click', prevQuestion);
        document.getElementById('finishRecordingBtn').addEventListener('click', finishRecording);
        document.getElementById('copyLinkBtn').addEventListener('click', copySubmissionLink);
        document.getElementById('newSubmissionBtn').addEventListener('click', resetApplication);

        // Difficulty level change handler
        document.getElementById('difficultyLevel').addEventListener('change', function() {
            const difficulty = this.value;
            if (difficulty === 'hard' && currentUser.plan === 'free') {
                alert('Hard difficulty is only available for Pro users. Please upgrade your plan.');
                this.value = 'medium';
            }
        });

        async function generateQuestions() {
            const candidateName = document.getElementById('candidateName').value.trim();
            const jobTitle = document.getElementById('jobTitle').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            const jobDescription = document.getElementById('jobDescription').value.trim();
            const difficulty = document.getElementById('difficultyLevel').value;

            if (!candidateName || !jobTitle || !companyName || !jobDescription) {
                alert('Please fill in all required fields.');
                return;
            }

            showLoading('Generating AI questions...');

            try {
                const response = await fetch('https://introvy-backend.vercel.app/api/ai/generate-questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jobDescription: jobDescription,
                        difficulty: difficulty,
                        questionCount: 3,
                        userPlan: currentUser.plan,
                        isRegeneration: false
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    applicationState.questions = data.questions;
                    applicationState.difficulty = difficulty;
                    displayQuestions();
                    updateStepIndicator(2);
                } else {
                    alert('Error generating questions: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('Failed to generate questions. Please try again.');
            }
        }

        async function regenerateQuestions() {
            if (currentUser.regenerationsUsed >= currentUser.maxRegenerations) {
                const upgradeMsg = currentUser.plan === 'free' 
                    ? 'You have used your free regeneration. Upgrade to Pro for more regenerations.'
                    : 'You have reached your regeneration limit.';
                alert(upgradeMsg);
                return;
            }

            const jobDescription = document.getElementById('jobDescription').value;
            const difficulty = document.getElementById('difficultyLevel').value;

            showLoading('Regenerating questions...');

            try {
                const response = await fetch('https://introvy-backend.vercel.app/api/ai/generate-questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jobDescription: jobDescription,
                        difficulty: difficulty,
                        questionCount: 3,
                        userPlan: currentUser.plan,
                        isRegeneration: true,
                        userId: 'user-' + Date.now(), // Temporary user ID
                        submissionId: applicationState.submissionId || 'temp-submission'
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    applicationState.questions = data.questions;
                    currentUser.regenerationsUsed++;
                    displayQuestions();
                    updateRegenerationStatus();
                } else {
                    alert('Error regenerating questions: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('Failed to regenerate questions. Please try again.');
            }
        }

        function displayQuestions() {
            const container = document.getElementById('questionsContainer');
            
            container.innerHTML = applicationState.questions.map((q, index) => `
                <div class="question-card mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Question ${index + 1}</h3>
                        <div class="difficulty-badge difficulty-${q.difficulty}">${q.difficulty.charAt(0).toUpperCase() + q.difficulty.slice(1)}</div>
                    </div>
                    <p class="text-gray-700">${q.question}</p>
                    <div class="mt-3 text-sm text-gray-500">
                        <i class="fas fa-tag mr-1"></i>Category: ${q.category}
                    </div>
                </div>
            `).join('');

            questionsSection.style.display = 'block';
            startRecordingBtn.style.display = 'inline-block';
            
            updateRegenerationStatus();
        }

        function updateRegenerationStatus() {
            const statusEl = document.getElementById('regenerationStatus');
            const regenerateBtn = document.getElementById('regenerateBtn');
            
            const remaining = currentUser.maxRegenerations - currentUser.regenerationsUsed;
            statusEl.textContent = `Regenerations: ${remaining}/${currentUser.maxRegenerations} remaining`;
            
            if (remaining > 0) {
                regenerateBtn.style.display = 'inline-block';
            } else {
                regenerateBtn.style.display = 'none';
            }
        }

        function startVideoRecording() {
            recordingSection.style.display = 'block';
            applicationState.currentQuestionIndex = 0;
            applicationState.videoResponses = new Array(applicationState.questions.length).fill(null);
            displayCurrentQuestion();
            updateStepIndicator(3);
        }

        function displayCurrentQuestion() {
            const question = applicationState.questions[applicationState.currentQuestionIndex];
            const questionNumber = applicationState.currentQuestionIndex + 1;
            const totalQuestions = applicationState.questions.length;

            document.getElementById('questionNumber').textContent = questionNumber;
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('questionDifficulty').textContent = question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1);
            document.getElementById('questionDifficulty').className = `difficulty-badge difficulty-${question.difficulty}`;

            // Update navigation buttons
            document.getElementById('prevQuestionBtn').style.display = questionNumber > 1 ? 'inline-block' : 'none';
            document.getElementById('nextQuestionBtn').style.display = questionNumber < totalQuestions ? 'inline-block' : 'none';
            document.getElementById('finishRecordingBtn').style.display = questionNumber === totalQuestions ? 'inline-block' : 'none';

            // Reset recording UI
            resetRecordingUI();
        }

        async function startRecording() {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                const videoPreview = document.getElementById('videoPreview');
                videoPreview.srcObject = currentStream;
                document.getElementById('videoPlaceholder').style.display = 'none';
                
                mediaRecorder = new MediaRecorder(currentStream, {
                    mimeType: 'video/webm;codecs=vp9'
                });
                
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    applicationState.videoResponses[applicationState.currentQuestionIndex] = {
                        blob: blob,
                        url: URL.createObjectURL(blob),
                        duration: Math.round((Date.now() - recordingStartTime) / 1000)
                    };
                    
                    videoPreview.srcObject = null;
                    videoPreview.src = applicationState.videoResponses[applicationState.currentQuestionIndex].url;
                    
                    currentStream.getTracks().forEach(track => track.stop());
                    
                    document.getElementById('retakeBtn').style.display = 'inline-block';
                    document.getElementById('recordingStatus').innerHTML = '<span class="text-green-600"><i class="fas fa-check mr-1"></i>Recording complete!</span>';
                    
                    updateNavigationButtons();
                };
                
                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                document.getElementById('startRecBtn').disabled = true;
                document.getElementById('stopRecBtn').disabled = false;
                document.getElementById('recordingStatus').innerHTML = '<span class="text-red-600"><i class="fas fa-circle mr-1"></i>Recording in progress...</span>';
                
                startTimer();
                
                // Auto-stop after 90 seconds
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopRecording();
                    }
                }, 90000);
                
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Error accessing camera/microphone. Please ensure permissions are granted.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('startRecBtn').disabled = false;
                document.getElementById('stopRecBtn').disabled = true;
                stopTimer();
            }
        }

        function retakeVideo() {
            applicationState.videoResponses[applicationState.currentQuestionIndex] = null;
            resetRecordingUI();
            document.getElementById('retakeBtn').style.display = 'none';
            updateNavigationButtons();
        }

        function resetRecordingUI() {
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.srcObject = null;
            videoPreview.src = '';
            document.getElementById('videoPlaceholder').style.display = 'flex';
            document.getElementById('startRecBtn').disabled = false;
            document.getElementById('stopRecBtn').disabled = true;
            document.getElementById('recordingStatus').innerHTML = '';
            document.getElementById('recordingTimer').textContent = '';
            document.getElementById('retakeBtn').style.display = 'none';
        }

        function startTimer() {
            recordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('recordingTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        function updateNavigationButtons() {
            const hasCurrentVideo = applicationState.videoResponses[applicationState.currentQuestionIndex] !== null;
            const nextBtn = document.getElementById('nextQuestionBtn');
            const finishBtn = document.getElementById('finishRecordingBtn');
            
            if (applicationState.currentQuestionIndex < applicationState.questions.length - 1) {
                nextBtn.style.display = hasCurrentVideo ? 'inline-block' : 'none';
            } else {
                const allVideosRecorded = applicationState.videoResponses.every(v => v !== null);
                finishBtn.style.display = allVideosRecorded ? 'inline-block' : 'none';
            }
        }

        function nextQuestion() {
            if (applicationState.currentQuestionIndex < applicationState.questions.length - 1) {
                applicationState.currentQuestionIndex++;
                displayCurrentQuestion();
            }
        }

        function prevQuestion() {
            if (applicationState.currentQuestionIndex > 0) {
                applicationState.currentQuestionIndex--;
                displayCurrentQuestion();
            }
        }

        async function finishRecording() {
            const allVideosRecorded = applicationState.videoResponses.every(v => v !== null);
            
            if (!allVideosRecorded) {
                alert('Please record responses for all questions before submitting.');
                return;
            }

            showLoading('Creating your submission...');

            try {
                // Create submission
                const submissionData = {
                    candidateName: document.getElementById('candidateName').value,
                    jobTitle: document.getElementById('jobTitle').value,
                    companyName: document.getElementById('companyName').value,
                    jobDescription: document.getElementById('jobDescription').value,
                    questions: applicationState.questions,
                    videoResponses: applicationState.videoResponses.map((video, index) => ({
                        questionId: index + 1,
                        question: applicationState.questions[index].question,
                        duration: video.duration,
                        recorded: true,
                        recordedAt: new Date().toISOString()
                    })),
                    difficulty: applicationState.difficulty,
                    submissionStatus: 'completed'
                };

                const response = await fetch('https://introvy-backend.vercel.app/api/submission/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(submissionData)
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    applicationState.submissionId = result.submissionId;
                    showSubmissionComplete(result.submissionId);
                    updateStepIndicator(4);
                } else {
                    alert('Error creating submission: ' + result.error);
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('Failed to create submission. Please try again.');
            }
        }

        function showSubmissionComplete(submissionId) {
            const submissionLink = `https://introvy-backend.vercel.app/api/submission-view?id=${submissionId}`;
            
            document.getElementById('submissionLink').value = submissionLink;
            document.getElementById('viewSubmissionBtn').href = submissionLink;
            
            recordingSection.style.display = 'none';
            submissionSection.style.display = 'block';
        }

        function copySubmissionLink() {
            const linkInput = document.getElementById('submissionLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                
                const btn = document.getElementById('copyLinkBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                btn.classList.add('bg-green-500');
                btn.classList.remove('bg-blue-500');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-500');
                    btn.classList.add('bg-blue-500');
                }, 2000);
            } catch (err) {
                alert('Failed to copy link. Please copy manually.');
            }
        }

        function resetApplication() {
            // Reset all state
            applicationState = {
                questions: [],
                currentQuestionIndex: 0,
                videoResponses: [],
                difficulty: 'medium',
                submissionId: null
            };
            
            // Reset form
            document.getElementById('candidateName').value = '';
            document.getElementById('jobTitle').value = '';
            document.getElementById('companyName').value = '';
            document.getElementById('jobDescription').value = '';
            document.getElementById('difficultyLevel').value = 'medium';
            
            // Hide sections
            questionsSection.style.display = 'none';
            recordingSection.style.display = 'none';
            submissionSection.style.display = 'none';
            
            // Reset step indicator
            updateStepIndicator(1);
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function updateStepIndicator(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                
                if (i < currentStep) {
                    stepEl.classList.add('completed');
                } else if (i === currentStep) {
                    stepEl.classList.add('active');
                }
            }
        }

        function showLoading(message) {
            document.getElementById('loadingText').textContent = message;
            loadingModal.style.display = 'flex';
        }

        function hideLoading() {
            loadingModal.style.display = 'none';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            updateRegenerationStatus();
            updateStepIndicator(1);
            
            // Set user plan based on URL params or default to free
            const urlParams = new URLSearchParams(window.location.search);
            const plan = urlParams.get('plan') || 'free';
            
            currentUser.plan = plan;
            currentUser.maxRegenerations = plan === 'pro' ? 2 : 1;
            
            document.getElementById('userPlan').textContent = plan === 'pro' ? 'Pro Plan' : 'Free Plan';
            document.getElementById('userPlan').className = `plan-badge plan-${plan}`;
        });
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"95895a74eb8cf790","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDkvVPaMaE0QYZ2vqUn3iWulyz07aND1LtZd5hvGn7ITHVbLqK6CKs4%2FyFCny4h0y31d6QLreZk83U23nad29Nk96%2BA8lKatOQYaNyqfqxOpk%2FirUGJZ1iEbw%2FgSMkVjqvJ4DDtoq2XjDgzhV6EBAcGXGJpBMoOeL0stMrxztNSG%2Fc04fSjdwEp5FWY2C8oWwrSFOcHE77eVcZRDsXS03DTdDIXyFsNaDdDOpCEXkzLcSFOyM2jLQlHx5ViVMCC%2Ftl9uXXKSZ62CsRXoPoyyxiV24DdO5w0Ib%2FdgM5%2BaC%2FVqYHFERDY0UIWd7Gx66Ay%2BzJSI2oCMOI3dCCWpqFK3SmrMvc78ZTJZUg27NNsp%2F9vJhuAa7BOJVkwXNSp%2FOxM65OA%2Bu7kSikuGuEG08%2BxmUhqUYfZTYHVdRHA9jFdmBPoXMBrMaiHFfOcC%2B51h%2FwJ%2BooaCJovGMUg1P2yqm%2F5TDx3LBazzf2W79QrzCkoREuIfOgxFOpf4DlFQiLvz%2B8VkDVBynpd0%2FYsFCMnLl%2BcAld%2Bw%3D";
        window.__genspark_locale = "en-US";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDkvVPaMaE0QYZ2vqUn3iWulyz07aND1LtZd5hvGn7ITHVbLqK6CKs4/yFCny4h0y31d6QLreZk83U23nad29Nk96+A8lKatOQYaNyqfqxOpk/irUGJZ1iEbw/gSMkVjqvJ4DDtoq2XjDgzhV6EBAcGXGJpBMoOeL0stMrxztNSG/c04fSjdwEp5FWY2C8oWwrSFOcHE77eVcZRDsXS03DTdDIXyFsNaDdDOpCEXkzLcSFOyM2jLQlHx5ViVMCC/tl9uXXKSZ62CsRXoPoyyxiV24DdO5w0Ib/dgM5+aC/VqYHFERDY0UIWd7Gx66Ay+zJSI2oCMOI3dCCWpqFK3SmrMvc78ZTJZUg27NNsp/9vJhuAa7BOJVkwXNSp/OxM65OA+u7kSikuGuEG08+xmUhqUYfZTYHVdRHA9jFdmBPoXMBrMaiHFfOcC+51h/wJ+ooaCJovGMUg1P2yqm/5TDx3LBazzf2W79QrzCkoREuIfOgxFOpf4DlFQiLvz+8VkDVBynpd0/YsFCMnLl+cAld+w=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
