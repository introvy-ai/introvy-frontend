<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Video Application - Introvy.ai</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .step-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .step-completed {
            background: #10b981;
            color: white;
        }
        .step-inactive {
            background: #e5e7eb;
            color: #6b7280;
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        .difficulty-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .difficulty-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .difficulty-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .question-card {
            border-left: 4px solid #667eea;
        }
        .recording-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-video text-2xl"></i>
                    <h1 class="text-2xl font-bold">Introvy.ai</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userPlanBadge" class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">Free Plan</span>
                    <a href="/" class="text-white hover:text-gray-200">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-center space-x-4">
                <div class="flex items-center">
                    <div id="step1" class="w-8 h-8 rounded-full step-active flex items-center justify-center text-sm font-semibold">1</div>
                    <span class="ml-2 text-sm font-medium">Job Details</span>
                </div>
                <div class="w-12 h-0.5 bg-gray-300"></div>
                <div class="flex items-center">
                    <div id="step2" class="w-8 h-8 rounded-full step-inactive flex items-center justify-center text-sm font-semibold">2</div>
                    <span class="ml-2 text-sm font-medium">Questions</span>
                </div>
                <div class="w-12 h-0.5 bg-gray-300"></div>
                <div class="flex items-center">
                    <div id="step3" class="w-8 h-8 rounded-full step-inactive flex items-center justify-center text-sm font-semibold">3</div>
                    <span class="ml-2 text-sm font-medium">Record</span>
                </div>
                <div class="w-12 h-0.5 bg-gray-300"></div>
                <div class="flex items-center">
                    <div id="step4" class="w-8 h-8 rounded-full step-inactive flex items-center justify-center text-sm font-semibold">4</div>
                    <span class="ml-2 text-sm font-medium">Submit</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">

            <!-- Step 1: Job Details -->
            <div id="jobDetailsStep" class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Create Your Video Application</h2>
                <p class="text-gray-600 mb-8">Get AI-generated interview questions tailored to any job posting and record personalized video responses.</p>
                
                <form id="jobDetailsForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Name *</label>
                            <input type="text" id="candidateName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="John Doe">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Job Title *</label>
                            <input type="text" id="jobTitle" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Software Engineer">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Name *</label>
                        <input type="text" id="companyName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Google">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job Description *</label>
                        <textarea id="jobDescription" required rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Paste the job description here..."></textarea>
                        <p class="text-sm text-gray-500 mt-2">Paste the complete job posting to get the most relevant questions.</p>
                    </div>

                    <!-- Difficulty Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-4">Question Difficulty</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="difficulty-card border-2 border-gray-200 rounded-lg p-4 selected" data-difficulty="easy">
                                <div class="text-center">
                                    <i class="fas fa-seedling text-2xl text-green-500 mb-2"></i>
                                    <h3 class="font-semibold">Easy</h3>
                                    <p class="text-sm text-gray-600 mt-2">Basic questions focusing on motivation and general skills</p>
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full mt-2 inline-block">Free Plan</span>
                                </div>
                            </div>
                            <div class="difficulty-card border-2 border-gray-200 rounded-lg p-4" data-difficulty="medium">
                                <div class="text-center">
                                    <i class="fas fa-balance-scale text-2xl text-blue-500 mb-2"></i>
                                    <h3 class="font-semibold">Medium</h3>
                                    <p class="text-sm text-gray-600 mt-2">Balanced technical and behavioral questions</p>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full mt-2 inline-block">Free Plan</span>
                                </div>
                            </div>
                            <div class="difficulty-card border-2 border-gray-200 rounded-lg p-4" data-difficulty="hard">
                                <div class="text-center">
                                    <i class="fas fa-brain text-2xl text-purple-500 mb-2"></i>
                                    <h3 class="font-semibold">Hard</h3>
                                    <p class="text-sm text-gray-600 mt-2">Advanced scenario-based and strategic questions</p>
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full mt-2 inline-block">Pro Only</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition duration-200">
                        <i class="fas fa-magic mr-2"></i>Generate AI Questions
                    </button>
                </form>
            </div>

            <!-- Step 2: Questions Generated -->
            <div id="questionsStep" class="bg-white rounded-lg shadow-lg p-8 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Your Interview Questions</h2>
                    <div id="regenerationInfo" class="text-sm text-gray-600">
                        <span id="regenerationCount">0/1</span> regenerations used
                    </div>
                </div>

                <div id="questionsContainer" class="space-y-4 mb-6">
                    <!-- Questions will be inserted here -->
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="regenerateBtn" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition duration-200">
                        <i class="fas fa-redo mr-2"></i>Regenerate Questions
                    </button>
                    <button id="startRecordingBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition duration-200">
                        <i class="fas fa-video mr-2"></i>Start Recording Answers
                    </button>
                </div>

                <!-- Upgrade Prompt for Free Users -->
                <div id="upgradePrompt" class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-lg hidden">
                    <div class="flex items-center">
                        <i class="fas fa-crown text-purple-500 mr-3"></i>
                        <div>
                            <h3 class="font-semibold text-purple-800">Upgrade to Pro for More Features</h3>
                            <p class="text-purple-600 text-sm">Get 2 regenerations per submission and access to hard difficulty questions.</p>
                        </div>
                        <button class="bg-purple-500 text-white px-4 py-2 rounded-lg ml-auto hover:bg-purple-600">Upgrade</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Video Recording -->
            <div id="recordingStep" class="bg-white rounded-lg shadow-lg p-8 hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Record Your Answers</h2>
                
                <div class="mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-2">
                            Question <span id="currentQuestionNumber">1</span> of <span id="totalQuestions">3</span>
                        </h3>
                        <p id="currentQuestion" class="text-blue-700">Your question will appear here...</p>
                    </div>
                </div>

                <div class="video-container mb-6">
                    <video id="videoPreview" autoplay muted playsinline class="w-full h-full object-cover"></video>
                    <div id="videoPlaceholder" class="absolute inset-0 flex items-center justify-center text-white">
                        <div class="text-center">
                            <i class="fas fa-video text-4xl mb-4"></i>
                            <p>Click "Start Recording" to begin</p>
                        </div>
                    </div>
                    <div id="recordingIndicator" class="absolute top-4 left-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm recording-pulse hidden">
                        <i class="fas fa-circle mr-1"></i>Recording...
                    </div>
                </div>

                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="startVideoBtn" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition duration-200">
                        <i class="fas fa-record-vinyl mr-2"></i>Start Recording
                    </button>
                    <button id="stopVideoBtn" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition duration-200" disabled>
                        <i class="fas fa-stop mr-2"></i>Stop Recording
                    </button>
                    <button id="retakeVideoBtn" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition duration-200 hidden">
                        <i class="fas fa-redo mr-2"></i>Retake
                    </button>
                    <button id="nextQuestionBtn" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition duration-200 hidden">
                        <i class="fas fa-arrow-right mr-2"></i>Next Question
                    </button>
                </div>

                <div id="recordingProgress" class="mb-6">
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300" style="width: 33%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Progress: <span id="questionsCompleted">0</span> of <span id="totalQuestionsProgress">3</span> questions answered</p>
                </div>
            </div>

            <!-- Step 4: Review & Submit -->
            <div id="reviewStep" class="bg-white rounded-lg shadow-lg p-8 hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Review Your Application</h2>
                
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="font-semibold text-gray-800 mb-4">Application Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Candidate:</span>
                            <span id="reviewCandidateName" class="font-medium ml-2">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Position:</span>
                            <span id="reviewJobTitle" class="font-medium ml-2">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Company:</span>
                            <span id="reviewCompanyName" class="font-medium ml-2">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Questions:</span>
                            <span id="reviewQuestionCount" class="font-medium ml-2">-</span>
                        </div>
                    </div>
                </div>

                <div id="reviewQuestions" class="space-y-4 mb-8">
                    <!-- Review questions will be inserted here -->
                </div>

                <button id="submitApplicationBtn" class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:from-green-600 hover:to-blue-700 transition duration-200">
                    <i class="fas fa-paper-plane mr-2"></i>Submit Application & Get Shareable Link
                </button>
            </div>

            <!-- Success Step -->
            <div id="successStep" class="bg-white rounded-lg shadow-lg p-8 text-center hidden">
                <div class="mb-6">
                    <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Application Submitted Successfully!</h2>
                    <p class="text-gray-600">Your video application has been created. Share the link below with employers.</p>
                </div>

                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Shareable Application Link:</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="submissionLink" readonly class="flex-1 p-3 bg-white border border-gray-300 rounded-lg text-sm">
                        <button id="copyLinkBtn" class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 transition duration-200">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="createAnotherBtn" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition duration-200">
                        <i class="fas fa-plus mr-2"></i>Create Another Application
                    </button>
                    <button id="viewSubmissionBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition duration-200">
                        <i class="fas fa-eye mr-2"></i>View As Employer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p id="loadingText" class="text-lg font-medium">Processing...</p>
            <p class="text-gray-600 mt-2">This may take a few moments</p>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let selectedDifficulty = 'easy';
        let currentUserPlan = 'free'; // This would come from authentication
        let generatedQuestions = [];
        let currentQuestionIndex = 0;
        let videoResponses = [];
        let mediaRecorder;
        let recordedChunks = [];
        let regenerationsUsed = 0;
        let submissionId = null;
        let userId = 'user-' + Math.random().toString(36).substr(2, 9); // Mock user ID

        // DOM elements
        const steps = {
            1: document.getElementById('jobDetailsStep'),
            2: document.getElementById('questionsStep'),
            3: document.getElementById('recordingStep'),
            4: document.getElementById('reviewStep'),
            success: document.getElementById('successStep')
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            updatePlanBadge();
            updateStepIndicators();
        }

        function setupEventListeners() {
            // Job details form
            document.getElementById('jobDetailsForm').addEventListener('submit', handleJobDetailsSubmit);
            
            // Difficulty selection
            document.querySelectorAll('.difficulty-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectDifficulty(this.dataset.difficulty);
                });
            });

            // Questions step
            document.getElementById('regenerateBtn').addEventListener('click', regenerateQuestions);
            document.getElementById('startRecordingBtn').addEventListener('click', startRecordingFlow);

            // Video recording
            document.getElementById('startVideoBtn').addEventListener('click', startVideoRecording);
            document.getElementById('stopVideoBtn').addEventListener('click', stopVideoRecording);
            document.getElementById('retakeVideoBtn').addEventListener('click', retakeVideo);
            document.getElementById('nextQuestionBtn').addEventListener('click', nextQuestion);

            // Review and submit
            document.getElementById('submitApplicationBtn').addEventListener('click', submitApplication);
            
            // Success actions
            document.getElementById('copyLinkBtn').addEventListener('click', copySubmissionLink);
            document.getElementById('createAnotherBtn').addEventListener('click', createAnother);
            document.getElementById('viewSubmissionBtn').addEventListener('click', viewSubmission);
        }

        function selectDifficulty(difficulty) {
            if (difficulty === 'hard' && currentUserPlan === 'free') {
                showUpgradePrompt();
                return;
            }

            selectedDifficulty = difficulty;
            document.querySelectorAll('.difficulty-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-difficulty="${difficulty}"]`).classList.add('selected');
        }

        async function handleJobDetailsSubmit(e) {
            e.preventDefault();
            
            const candidateName = document.getElementById('candidateName').value;
            const jobTitle = document.getElementById('jobTitle').value;
            const companyName = document.getElementById('companyName').value;
            const jobDescription = document.getElementById('jobDescription').value;

            if (!candidateName || !jobTitle || !companyName || !jobDescription) {
                alert('Please fill in all required fields.');
                return;
            }

            await generateQuestions({
                candidateName,
                jobTitle,
                companyName,
                jobDescription,
                difficulty: selectedDifficulty
            });
        }

        async function generateQuestions(formData, isRegeneration = false) {
            showLoading('Generating AI questions...');

            try {
                const response = await fetch('https://introvy-backend.vercel.app/api/ai/generate-questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jobDescription: formData.jobDescription,
                        difficulty: selectedDifficulty,
                        questionCount: 3,
                        userId: userId,
                        submissionId: submissionId,
                        isRegeneration: isRegeneration,
                        userPlan: currentUserPlan
                    })
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    generatedQuestions = result.questions;
                    if (isRegeneration) {
                        regenerationsUsed++;
                        updateRegenerationInfo();
                    }
                    displayQuestions();
                    if (!isRegeneration) {
                        updateFormData(formData);
                        goToStep(2);
                    }
                } else {
                    alert('Error: ' + result.error);
                    if (result.error.includes('Upgrade to Pro')) {
                        showUpgradePrompt();
                    }
                }
            } catch (error) {
                hideLoading();
                console.error('Error generating questions:', error);
                alert('Failed to generate questions. Please try again.');
            }
        }

        function displayQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            generatedQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card bg-gray-50 p-4 rounded-lg';
                questionCard.innerHTML = `
                    <div class="flex items-start">
                        <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-semibold mr-3 mt-1">
                            ${index + 1}
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium">${question.question}</p>
                            <div class="flex items-center mt-2 space-x-2">
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${question.category}</span>
                                <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${question.difficulty}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(questionCard);
            });

            updateRegenerationInfo();
        }

        function updateRegenerationInfo() {
            const maxRegens = currentUserPlan === 'pro' ? 2 : 1;
            document.getElementById('regenerationCount').textContent = `${regenerationsUsed}/${maxRegens}`;
            
            const regenerateBtn = document.getElementById('regenerateBtn');
            if (regenerationsUsed >= maxRegens) {
                regenerateBtn.disabled = true;
                regenerateBtn.innerHTML = '<i class="fas fa-ban mr-2"></i>Regeneration Limit Reached';
                regenerateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        async function regenerateQuestions() {
            const maxRegens = currentUserPlan === 'pro' ? 2 : 1;
            if (regenerationsUsed >= maxRegens) {
                if (currentUserPlan === 'free') {
                    showUpgradePrompt();
                }
                return;
            }

            const formData = {
                jobDescription: document.getElementById('jobDescription').value
            };

            await generateQuestions(formData, true);
        }

        function showUpgradePrompt() {
            document.getElementById('upgradePrompt').classList.remove('hidden');
        }

        function startRecordingFlow() {
            goToStep(3);
            setupVideoRecording();
        }

        async function setupVideoRecording() {
            currentQuestionIndex = 0;
            videoResponses = [];
            updateCurrentQuestion();
            updateRecordingProgress();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                const videoPreview = document.getElementById('videoPreview');
                videoPreview.srcObject = stream;
                document.getElementById('videoPlaceholder').style.display = 'none';
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Error accessing camera/microphone. Please ensure permissions are granted.');
            }
        }

        function updateCurrentQuestion() {
            const question = generatedQuestions[currentQuestionIndex];
            document.getElementById('currentQuestionNumber').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = generatedQuestions.length;
            document.getElementById('currentQuestion').textContent = question.question;
        }

        function updateRecordingProgress() {
            const completed = videoResponses.length;
            const total = generatedQuestions.length;
            const percentage = (completed / total) * 100;
            
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('questionsCompleted').textContent = completed;
            document.getElementById('totalQuestionsProgress').textContent = total;
        }

        async function startVideoRecording() {
            try {
                const videoPreview = document.getElementById('videoPreview');
                const stream = videoPreview.srcObject;
                
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9'
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                    saveVideoResponse(videoBlob);
                };
                
                mediaRecorder.start();
                
                document.getElementById('startVideoBtn').disabled = true;
                document.getElementById('stopVideoBtn').disabled = false;
                document.getElementById('recordingIndicator').classList.remove('hidden');
                
                // Auto-stop after 2 minutes
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopVideoRecording();
                    }
                }, 120000);
                
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Error starting video recording.');
            }
        }

        function stopVideoRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('startVideoBtn').disabled = false;
                document.getElementById('stopVideoBtn').disabled = true;
                document.getElementById('recordingIndicator').classList.add('hidden');
                document.getElementById('retakeVideoBtn').classList.remove('hidden');
                document.getElementById('nextQuestionBtn').classList.remove('hidden');
            }
        }

        function saveVideoResponse(videoBlob) {
            const question = generatedQuestions[currentQuestionIndex];
            videoResponses[currentQuestionIndex] = {
                questionId: question.id,
                question: question.question,
                videoBlob: videoBlob,
                duration: 60, // Approximate
                recordedAt: new Date().toISOString()
            };
            updateRecordingProgress();
        }

        function retakeVideo() {
            recordedChunks = [];
            videoResponses[currentQuestionIndex] = null;
            document.getElementById('retakeVideoBtn').classList.add('hidden');
            document.getElementById('nextQuestionBtn').classList.add('hidden');
            updateRecordingProgress();
        }

        function nextQuestion() {
            if (currentQuestionIndex < generatedQuestions.length - 1) {
                currentQuestionIndex++;
                updateCurrentQuestion();
                document.getElementById('retakeVideoBtn').classList.add('hidden');
                document.getElementById('nextQuestionBtn').classList.add('hidden');
            } else {
                // All questions completed
                goToStep(4);
                setupReviewStep();
            }
        }

        function setupReviewStep() {
            // Update review information
            document.getElementById('reviewCandidateName').textContent = document.getElementById('candidateName').value;
            document.getElementById('reviewJobTitle').textContent = document.getElementById('jobTitle').value;
            document.getElementById('reviewCompanyName').textContent = document.getElementById('companyName').value;
            document.getElementById('reviewQuestionCount').textContent = generatedQuestions.length;

            // Display questions with recording status
            const reviewContainer = document.getElementById('reviewQuestions');
            reviewContainer.innerHTML = '';

            generatedQuestions.forEach((question, index) => {
                const hasRecording = videoResponses[index] && videoResponses[index].videoBlob;
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500';
                questionDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-800">Question ${index + 1}</h4>
                            <p class="text-gray-600 mt-1">${question.question}</p>
                        </div>
                        <div class="ml-4">
                            ${hasRecording 
                                ? '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm"><i class="fas fa-check mr-1"></i>Recorded</span>'
                                : '<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm"><i class="fas fa-times mr-1"></i>Not Recorded</span>'
                            }
                        </div>
                    </div>
                `;
                reviewContainer.appendChild(questionDiv);
            });
        }

        async function submitApplication() {
            const allRecorded = videoResponses.every(response => response && response.videoBlob);
            if (!allRecorded) {
                alert('Please record answers for all questions before submitting.');
                return;
            }

            showLoading('Creating your application...');

            try {
                // Prepare submission data
                const submissionData = {
                    candidateName: document.getElementById('candidateName').value,
                    jobTitle: document.getElementById('jobTitle').value,
                    companyName: document.getElementById('companyName').value,
                    jobDescription: document.getElementById('jobDescription').value,
                    questions: generatedQuestions,
                    videoResponses: videoResponses.map(response => ({
                        questionId: response.questionId,
                        question: response.question,
                        duration: response.duration,
                        recordedAt: response.recordedAt,
                        hasVideo: true
                    })),
                    difficulty: selectedDifficulty,
                    userPlan: currentUserPlan,
                    regenerationsUsed: regenerationsUsed
                };

                const response = await fetch('https://introvy-backend.vercel.app/api/submission/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(submissionData)
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    submissionId = result.submissionId || result.shareToken;
                    const submissionUrl = `https://introvy-backend.vercel.app/api/submission-view?id=${submissionId}`;
                    document.getElementById('submissionLink').value = submissionUrl;
                    goToStep('success');
                } else {
                    alert('Error creating submission: ' + result.error);
                }
            } catch (error) {
                hideLoading();
                console.error('Error submitting application:', error);
                alert('Failed to submit application. Please try again.');
            }
        }

        function copySubmissionLink() {
            const linkInput = document.getElementById('submissionLink');
            linkInput.select();
            document.execCommand('copy');
            
            const copyBtn = document.getElementById('copyLinkBtn');
            const originalHTML = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
            copyBtn.classList.add('bg-green-500');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalHTML;
                copyBtn.classList.remove('bg-green-500');
            }, 2000);
        }

        function createAnother() {
            location.reload();
        }

        function viewSubmission() {
            const submissionUrl = document.getElementById('submissionLink').value;
            window.open(submissionUrl, '_blank');
        }

        function updateFormData(data) {
            window.currentFormData = data;
        }

        function goToStep(step) {
            // Hide all steps
            Object.values(steps).forEach(stepElement => {
                stepElement.classList.add('hidden');
            });

            // Show target step
            if (step === 'success') {
                steps.success.classList.remove('hidden');
                updateStepIndicators(4);
            } else {
                steps[step].classList.remove('hidden');
                currentStep = step;
                updateStepIndicators(step);
            }
        }

        function updateStepIndicators(activeStep = currentStep) {
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (i < activeStep) {
                    stepElement.className = 'w-8 h-8 rounded-full step-completed flex items-center justify-center text-sm font-semibold';
                } else if (i === activeStep) {
                    stepElement.className = 'w-8 h-8 rounded-full step-active flex items-center justify-center text-sm font-semibold';
                } else {
                    stepElement.className = 'w-8 h-8 rounded-full step-inactive flex items-center justify-center text-sm font-semibold';
                }
            }
        }

        function updatePlanBadge() {
            const badge = document.getElementById('userPlanBadge');
            badge.textContent = currentUserPlan === 'pro' ? 'Pro Plan' : 'Free Plan';
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingModal').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.add('hidden');
        }
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9588767c3e6261c0","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDj8AqbrSmj%2BenD54qifln4Cap%2F3wLgmTftccB1zXtyq9EUzv84Zs7Uc%2BZ4IsDoWDXt%2FaQ0EWo1b%2B7RhBd3ciGx4WEdKjQ9x8MFJXfH%2F4Ygcrf7%2F%2FzxPqjLBU2nU3QssWexlrlKpb4ix8knDw11y7crCmE%2B0mqW06RpVS8ymTp%2FHFK7G7JeMzfwq6K7YlGVfE3lGmK3XHUMXHX80Jz%2F%2BvXa8zOy43Sc2o8xNLimRoR9QpYLGZHchspjUOkwj3OioXwlp0HZzUuzotdLSxMPQ0z%2BYWhc6078w4z0HtJQ23xiBnSDjaUa3wCC0B1%2BTekJBluhxPgfBePc98QkYxUmP5iuOA6HU7ZdWvFMsI9QubWwHRl2mmIm26tRTPEKyNqw%2BjfXyJyalmez2eD9lkUCnGcOEtDKQnjqZ2CDWk1syvSc3xtr35YxmZgHrDhSlgUi5vAmEgagmgWLDXQOVxdh2goxPdVYl3SLNnVH%2B4aQf6yXK1boih%2B8KmhyKlyjyDZTjf0GYkYpMUyynLYqlOFyFZDBE%3D";
        window.__genspark_locale = "en-US";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDj8AqbrSmj+enD54qifln4Cap/3wLgmTftccB1zXtyq9EUzv84Zs7Uc+Z4IsDoWDXt/aQ0EWo1b+7RhBd3ciGx4WEdKjQ9x8MFJXfH/4Ygcrf7//zxPqjLBU2nU3QssWexlrlKpb4ix8knDw11y7crCmE+0mqW06RpVS8ymTp/HFK7G7JeMzfwq6K7YlGVfE3lGmK3XHUMXHX80Jz/+vXa8zOy43Sc2o8xNLimRoR9QpYLGZHchspjUOkwj3OioXwlp0HZzUuzotdLSxMPQ0z+YWhc6078w4z0HtJQ23xiBnSDjaUa3wCC0B1+TekJBluhxPgfBePc98QkYxUmP5iuOA6HU7ZdWvFMsI9QubWwHRl2mmIm26tRTPEKyNqw+jfXyJyalmez2eD9lkUCnGcOEtDKQnjqZ2CDWk1syvSc3xtr35YxmZgHrDhSlgUi5vAmEgagmgWLDXQOVxdh2goxPdVYl3SLNnVH+4aQf6yXK1boih+8KmhyKlyjyDZTjf0GYkYpMUyynLYqlOFyFZDBE=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    